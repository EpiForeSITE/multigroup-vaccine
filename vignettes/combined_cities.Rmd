---
title: "Combined City Population: Measles Outbreak Modeling"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Combined City Population: Measles Outbreak Modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 11,
  fig.height = 7
)
```

```{css, echo=FALSE}
body {
  max-width: 1100px;
  margin: auto;
  padding: 1em;
}

table {
  width: 100%;
}
```

## Important Disclaimer

**WARNING: This vignette is for demonstration purposes only.**

This analysis includes many assumptions about vaccination rates, vaccination efficacy, contact rates, populations, and other epidemiological parameters. The results presented here should **NOT** be used to guide public health decision making. This vignette is meant solely to demonstrate the functionality of the `multigroup.vaccine` package and illustrate modeling techniques. Any public health decisions should be based on comprehensive analyses conducted by qualified epidemiologists and public health officials using validated data and methods.

## Introduction
```{r setup}
library(multigroup.vaccine)
library(socialmixr)
library(ggplot2)

# Load city data files
hildale_path <- system.file("extdata", "hildale_ut_2023.csv", package = "multigroup.vaccine")
colorado_city_path <- system.file("extdata", "colorado_city_az_2023.csv", package = "multigroup.vaccine")
```

## Measles Model Setup

For measles outbreak modeling in the combined population of Hildale, UT and Colorado City, AZ, we'll use granular age groups that separate school levels: pre-school (0-4), elementary (5-12), middle school (13-14), high school (15-18), and adult age bands.

```{r age-setup}
# Age groups: 0-4, 5-11 (elementary K-6), 12-13 (middle 7-8), 14-17 (high 9-12), 18-24, 25-34, 35-44, 45-54, 55-64, 65+
agelims <- c(0, 5, 12, 14, 18, 25, 35, 45, 55, 65)

# Vaccine effectiveness by age group
ageveff <- rep(0.97, length(agelims))  # All groups have high effectiveness
ageveff[1] <- 0.93  # Under 5 may have slightly lower effectiveness

# Initial infection in the 25-29 age group (working age adults)
# This corresponds to age group 25-34 (index 6)
initgrp <- 6
```

## Getting Combined City Population Data

We'll combine the populations of Hildale, UT and Colorado City, AZ by disaggregating their ACS 5-year age groups into single-year ages, then summing across both cities, and finally aggregating into school age groups.

```{r get-combined-data}
# Get single-year age data for both cities
cities <- c("Hildale city, Utah", "Colorado City town, Arizona")
city_paths <- c(hildale_path, colorado_city_path)

single_year_data <- list()

for (i in seq_along(cities)) {
  data <- getCityData(
    city_name = cities[i],
    csv_path = city_paths[i],
    age_groups = NULL  # Single-year ages
  )
  single_year_data[[cities[i]]] <- data
}

# Combine populations by summing across cities for each age
combined_ages <- single_year_data[[1]]$age_pops * 0  # Initialize with zeros
age_labels <- single_year_data[[1]]$age_labels
total_pop <- 0

for (city_data in single_year_data) {
  combined_ages <- combined_ages + city_data$age_pops
  total_pop <- total_pop + city_data$total_pop
}

# Now aggregate into school age groups
ages_numeric <- 0:85  # Ages 0 through 85
grouped <- aggregateByAgeGroups(ages_numeric, combined_ages, agelims)

combined_data <- list(
  city = "Combined Hildale, UT and Colorado City, AZ",
  year = 2023,
  total_pop = total_pop,
  age_pops = grouped$pops,
  age_labels = grouped$labels,
  data = NULL  # No single data frame for combined
)

cat("Combined Population Data:\n")
cat("Total population:", format(combined_data$total_pop, big.mark = ","), "\n")
cat("Age distribution:\n")
for (i in seq_along(combined_data$age_labels)) {
  pct <- 100 * combined_data$age_pops[i] / combined_data$total_pop
  cat(sprintf("  %s: %s (%.1f%%)\n",
              combined_data$age_labels[i],
              format(combined_data$age_pops[i], big.mark = ","),
              pct))
}
```

## Scenario 1: Current Vaccination Coverage (95% adult rate)

Let's model outbreaks under estimated vaccination coverage levels for the combined community.

```{r scenario1-setup}
# Vaccination coverage rates
# Assume 95% coverage for adults (19+), lower for children
vaxcov <- c(
  0.44,  # under 5
  0.45,  # 5-11 elementary
  0.50,  # 12-13 middle
  0.45,  # 14-17 high
  0.95,  # 18-24
  0.95,  # 25-34
  0.95,  # 35-44
  0.95,  # 45-54
  0.95,  # 55-64
  0.95   # 65+
)

current_coverage_95 <- vaxcov  # For compatibility with interpolation code
```

```{r scenario1-model}
# Run the measles model using getOutputTable
results1 <- getOutputTable(
  agelims = agelims,
  agepops = combined_data$age_pops,
  agecovr = vaxcov,
  ageveff = ageveff,
  initgrp = initgrp
)

cat("Combined Cities - Current Vaccination Coverage\n")
print(as.data.frame(results1), row.names = FALSE)

# Extract results for R0=15 (typical measles R0)
r0_15_idx <- which(results1[, "R0"] == 15)
final_size1 <- results1[r0_15_idx, "escapeInfTot"]
percent_infected1 <- 100 * final_size1 / combined_data$total_pop

cat("Final outbreak size (R0=15):", format(final_size1, big.mark = ","), "\n")
cat("Overall % infected:", sprintf("%.2f%%", percent_infected1), "\n")
```

## Scenario 2: Linear Interpolation of Adult Vaccination Rates

Now let's examine the impact using linear interpolation of adult vaccination rates (similar to the individual city analysis).

```{r scenario2-setup}
# Linear interpolation of adult vaccination rates
# Interpolate between 45% (end of high school) and 95% (older adults)
adult_ages <- c(15, 20, 25, 30, 35, 40, 45, 50)
adult_rates <- seq(0.45, 0.95, length.out = length(adult_ages))

vaxcov2 <- current_coverage_95  # Start with current coverage

for (i in seq_along(adult_ages)) {
  age <- adult_ages[i]
  rate <- adult_rates[i]
  age_idx <- which(agelims[-length(agelims)] == age)
  if (length(age_idx) > 0) {
    vaxcov2[age_idx] <- rate
  }
}

cat("Scenario 2: Linear interpolated adult vaccination coverage\n")
cat("Vaccination coverage rates:", paste0(100 * vaxcov2, "%", collapse = ", "), "\n")
```

```{r scenario2-model}
results2 <- getOutputTable(
  agelims = agelims,
  agepops = combined_data$age_pops,
  agecovr = vaxcov2,
  ageveff = ageveff,
  initgrp = initgrp
)

cat("Combined Cities - Linear Interpolated Adult Vaccination Coverage\n")
print(as.data.frame(results2), row.names = FALSE)

final_size2 <- results2[r0_15_idx, "escapeInfTot"]
percent_infected2 <- 100 * final_size2 / combined_data$total_pop

cat("Final outbreak size (R0=15):", format(final_size2, big.mark = ","), "\n")
cat("Overall % infected:", sprintf("%.2f%%", percent_infected2), "\n")
```

## Scenario Comparison

Let's compare the two scenarios side by side.

```{r scenario-comparison-plot}
# Create data frame for ggplot
comparison_data <- data.frame(
  Scenario = factor(c("95% Adult Coverage", "Linear Interpolated Adult Coverage"), 
                   levels = c("95% Adult Coverage", "Linear Interpolated Adult Coverage")),
  Percent_Infected = c(percent_infected1, percent_infected2),
  Final_Size = c(final_size1, final_size2),
  Color = c("#f7b360", "#9dd7da")
)

ggplot(comparison_data, aes(x = Scenario, y = Percent_Infected, fill = Color)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", Percent_Infected)), vjust = -0.5, size = 4) +
  scale_fill_identity() +
  labs(title = "Combined Cities: % Infected by Vaccination Scenario (R0=15)",
       x = "Vaccination Scenario",
       y = "% Infected") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  ylim(0, max(comparison_data$Percent_Infected) * 1.1)
```
