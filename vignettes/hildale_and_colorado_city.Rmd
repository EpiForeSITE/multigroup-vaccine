---
title: "City Population Data: Measles Outbreak Modeling Comparison"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{City Population Data: Measles Outbreak Modeling Comparison}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 11,
  fig.height = 7
)
```

```{css, echo=FALSE}
body {
  max-width: 1100px;
  margin: auto;
  padding: 1em;
}

table {
  width: 100%;
}
```

## Important Disclaimer

**WARNING: This vignette is for demonstration purposes only.**

This analysis includes many assumptions about vaccination rates, vaccination efficacy, contact rates, populations, and other epidemiological parameters. The results presented here should **NOT** be used to guide public health decision making. This vignette is meant solely to demonstrate the functionality of the `multigroup.vaccine` package and illustrate modeling techniques. Any public health decisions should be based on comprehensive analyses conducted by qualified epidemiologists and public health officials using validated data and methods.

## Introduction
```{r setup}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  stop("Package 'ggplot2' is needed for this vignette. Please install it.")
}

library(multigroup.vaccine)
library(socialmixr)
library(ggplot2)

# Load city data files
hildale_path <- system.file("extdata", "hildale_ut_2023.csv", package = "multigroup.vaccine")
colorado_city_path <- system.file("extdata", "colorado_city_az_2023.csv", package = "multigroup.vaccine")
```

## Measles Model Setup

For measles outbreak modeling, we'll use age groups based on the available ACS data:

```{r age-setup}
# Age groups based on ACS 5-year intervals, adjusted to avoid zero populations
agelims <- c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70)

# Vaccine effectiveness by age group (adjusted for these age groups)
# Using approximate values for these broader age categories
ageveff <- rep(0.97, length(agelims))  # Most age groups have high effectiveness
ageveff[1] <- 0.93  # Under 5 may have slightly lower effectiveness

# Initial infection in the 25-29 age group (working age adults)
# This corresponds to age group 25-29 (index 6)
initgrp <- 6
```



## Getting City Population Data

The `getCityData` function provides flexible age grouping options:

1. **Default 5-year groups**: Matches the ACS data structure
2. **Single-year ages**: Set `age_groups = NULL` to disaggregate 5-year groups uniformly
3. **Custom age groups**: Specify any age limits vector

Let's demonstrate these options with Hildale, UT data:

```{r get-city-data-examples}
# Example 1: Default 5-year age groups (0-4, 5-9, 10-14, ...)
hildale_5yr <- getCityData(
  city_name = "Hildale city, Utah",
  csv_path = hildale_path
)

cat("Example 1: Default 5-year age groups\n")
cat("Total population:", format(hildale_5yr$total_pop, big.mark = ","), "\n")
cat("Number of age groups:", length(hildale_5yr$age_pops), "\n")
cat("First few groups:", paste(head(hildale_5yr$age_labels, 3), collapse = ", "), "\n\n")

# Example 2: Single-year ages (disaggregated from 5-year ACS groups)
hildale_1yr <- getCityData(
  city_name = "Hildale city, Utah",
  csv_path = hildale_path,
  age_groups = NULL
)

cat("Example 2: Single-year ages (disaggregated)\n")
cat("Total population:", format(hildale_1yr$total_pop, big.mark = ","), "\n")
cat("Number of age groups:", length(hildale_1yr$age_pops), "\n")
cat("First few ages:", paste(head(hildale_1yr$age_labels, 5), collapse = ", "), "\n\n")

# Example 3: Custom age groups (0-18, 18-65, 65+)
hildale_custom <- getCityData(
  city_name = "Hildale city, Utah",
  csv_path = hildale_path,
  age_groups = c(0, 18, 65)
)

cat("Example 3: Custom age groups (0-18, 18-65, 65+)\n")
cat("Total population:", format(hildale_custom$total_pop, big.mark = ","), "\n")
for (i in seq_along(hildale_custom$age_labels)) {
  pct <- 100 * hildale_custom$age_pops[i] / hildale_custom$total_pop
  cat(sprintf("  %s: %s (%.1f%%)\n",
              hildale_custom$age_labels[i],
              format(hildale_custom$age_pops[i], big.mark = ","),
              pct))
}
```

Now let's retrieve population data for both cities using our custom age groups for measles modeling:

```{r get-city-data}
cities <- c("Hildale city, Utah", "Colorado City town, Arizona")

city_data_list <- list()

for (city in cities) {
  if (grepl("Hildale", city)) {
    csv_path <- hildale_path
  } else {
    csv_path <- colorado_city_path
  }

  data <- getCityData(
    city_name = city,
    csv_path = csv_path,
    age_groups = agelims
  )

  city_data_list[[city]] <- data

  cat("\n", city, ":\n", sep = "")
  cat("  Total population:", format(data$total_pop, big.mark = ","), "\n")
  cat("  Age distribution:\n")
  for (i in seq_along(data$age_labels)) {
    pct <- 100 * data$age_pops[i] / data$total_pop
    cat(sprintf("    %s: %s (%.1f%%)\n",
                data$age_labels[i],
                format(data$age_pops[i], big.mark = ","),
                pct))
  }
}
```

## Scenario 1: Current Vaccination Coverage (95% adult rate)

Let's model outbreaks under estimated vaccination coverage levels for these communities.

```{r scenario1-setup}
# Estimated vaccination coverage for these communities
# These are approximate values based on general Utah/Arizona vaccination rates
# School age children vaccination rate is based on the data available for 2024
# For adults, we assume 95% coverage for a conservative modeling approach
current_coverage_95 <- c(
  0.44,  # under 5, assume 1 percentage point lower than 5-9
  0.45,  # 5-9
  0.50,  # 10-14
  0.45,  # 15-19
  0.95,  # 20-24
  0.95,  # 25-29
  0.95,  # 30-34
  0.95,  # 35-39
  0.95,  # 40-44
  0.95,  # 45-49
  0.95,  # 50-54
  0.95,  # 55-59
  0.95,  # 60-64
  0.95,  # 65-69
  1.00   # 70+
)
```

### Hildale, Utah - Current Coverage (95% adult rate)

```{r hildale-current}
hildale_data <- city_data_list[["Hildale city, Utah"]]

hildale_current <- multigroup.vaccine:::getOutputTable(
  agelims = agelims,
  agepops = hildale_data$age_pops,
  agecovr = current_coverage_95,
  ageveff = ageveff,
  initgrp = initgrp
)

cat("Hildale, Utah - Current Vaccination Coverage\n")
print(as.data.frame(hildale_current), row.names = FALSE)
```

### Colorado City, Arizona - Current Coverage (95% adult rate)

```{r colorado-current}
colorado_data <- city_data_list[["Colorado City town, Arizona"]]

colorado_current <- multigroup.vaccine:::getOutputTable(
  agelims = agelims,
  agepops = colorado_data$age_pops,
  agecovr = current_coverage_95,
  ageveff = ageveff,
  initgrp = initgrp
)

cat("\nColorado City, Arizona - Current Vaccination Coverage\n")
print(as.data.frame(colorado_current), row.names = FALSE)
```
## Visualization: Comparing Cities

Let's visualize the outbreak potential across the two cities:

```{r plot-comparison-current}
# Extract R0=15 results for comparison
r0_15_idx <- which(hildale_current[, "R0"] == 15)

# Calculate combined city data
combined_age_pops <- hildale_data$age_pops + colorado_data$age_pops
combined_total_pop <- hildale_data$total_pop + colorado_data$total_pop

combined_current <- multigroup.vaccine:::getOutputTable(
  agelims = agelims,
  agepops = combined_age_pops,
  agecovr = current_coverage_95,
  ageveff = ageveff,
  initgrp = initgrp
)

cities_names <- c("Hildale, UT", "Colorado City, AZ", "Combined")
escape_pcts <- c(
  100 * hildale_current[r0_15_idx, "escapeInfTot"] / hildale_data$total_pop,
  100 * colorado_current[r0_15_idx, "escapeInfTot"] / colorado_data$total_pop,
  100 * combined_current[r0_15_idx, "escapeInfTot"] / combined_total_pop
)

# Create data frame for ggplot
plot_data <- data.frame(
  City = factor(cities_names, levels = cities_names),
  Percentage = escape_pcts,
  Color = c("#f7b360", "#9dd7da", "#c77dff")
)

ggplot(plot_data, aes(x = City, y = Percentage, fill = Color)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), vjust = -0.5, size = 4) +
  scale_fill_identity() +
  labs(title = "Potential Outbreak Size (R0=15)\nCurrent Coverage",
       x = "City",
       y = "% of Population Infected") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  ylim(0, max(escape_pcts) * 1.1)
```

Now with a lower R0 value:

```{r plot-comparison-current-r0-10}
# Extract R0=10 results for comparison
r0_10_idx <- which(hildale_current[, "R0"] == 10)

escape_pcts_10 <- c(
  100 * hildale_current[r0_10_idx, "escapeInfTot"] / hildale_data$total_pop,
  100 * colorado_current[r0_10_idx, "escapeInfTot"] / colorado_data$total_pop,
  100 * combined_current[r0_10_idx, "escapeInfTot"] / combined_total_pop
)

# Create data frame for ggplot
plot_data_10 <- data.frame(
  City = factor(cities_names, levels = cities_names),
  Percentage = escape_pcts_10,
  Color = c("#f7b360", "#9dd7da", "#c77dff")
)

ggplot(plot_data_10, aes(x = City, y = Percentage, fill = Color)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), vjust = -0.5, size = 4) +
  scale_fill_identity() +
  labs(title = "Potential Outbreak Size (R0=10)\nCurrent Coverage",
       x = "City",
       y = "% of Population Infected") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  ylim(0, max(escape_pcts_10) * 1.1)
```

## Comparison of R0 Values with Trend Analysis

Let's compare how different R0 values impact the outbreak size (in % of pop) in these communities under current vaccination coverage, including trendlines and statistical comparison:

```{r r0-comparison-plot}
r0_values <- c(10, 11, 12, 13, 14, 15, 16, 17, 18)
hildale_percents <- numeric(length(r0_values))
colorado_percents <- numeric(length(r0_values))
combined_percents <- numeric(length(r0_values))

for (i in seq_along(r0_values)) {
  r0_idx_hildale <- which(hildale_current[, "R0"] == r0_values[i])
  r0_idx_colorado <- which(colorado_current[, "R0"] == r0_values[i])
  r0_idx_combined <- which(combined_current[, "R0"] == r0_values[i])

  hildale_percents[i] <- 100 * hildale_current[r0_idx_hildale, "escapeInfTot"] / hildale_data$total_pop
  colorado_percents[i] <- 100 * colorado_current[r0_idx_colorado, "escapeInfTot"] / colorado_data$total_pop
  combined_percents[i] <- 100 * combined_current[r0_idx_combined, "escapeInfTot"] / combined_total_pop
}

# Create data frame for ggplot
r0_data <- data.frame(
  R0 = rep(r0_values, 3),
  Percentage = c(hildale_percents, colorado_percents, combined_percents),
  City = rep(c("Hildale, UT", "Colorado City, AZ", "Combined"), each = length(r0_values)),
  Color = rep(c("blue", "red", "purple"), each = length(r0_values))
)

# Fit linear models for trendlines
hildale_lm <- lm(hildale_percents ~ r0_values)
colorado_lm <- lm(colorado_percents ~ r0_values)
combined_lm <- lm(combined_percents ~ r0_values)

# Create trendline data
trend_data <- data.frame(
  R0 = rep(r0_values, 3),
  Trend = c(predict(hildale_lm), predict(colorado_lm), predict(combined_lm)),
  City = rep(c("Hildale, UT", "Colorado City, AZ", "Combined"), each = length(r0_values))
)

ggplot() +
  geom_line(data = r0_data, aes(x = R0, y = Percentage, color = City), linewidth = 1) +
  geom_point(data = r0_data, aes(x = R0, y = Percentage, color = City), size = 3) +
  geom_line(data = trend_data, aes(x = R0, y = Trend, color = City), linetype = "dashed", linewidth = 1) +
  scale_color_manual(values = c("Hildale, UT" = "blue", "Colorado City, AZ" = "red", "Combined" = "purple")) +
  labs(title = "Outbreak Size vs R0 Value\n(Current Vaccination Coverage)",
       x = "R0 Value",
       y = "% of Population Infected") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylim(15, max(r0_data$Percentage) * 1.1)
```

## Statistical Comparison of Trendlines

Let's perform a statistical comparison of the relationship between R0 values and outbreak size for the cities and combined population:

```{r statistical-comparison}
# Extract slope coefficients and their standard errors
hildale_summary <- summary(hildale_lm)
colorado_summary <- summary(colorado_lm)
combined_summary <- summary(combined_lm)

hildale_slope <- coef(hildale_summary)[2, 1]
hildale_se <- coef(hildale_summary)[2, 2]

colorado_slope <- coef(colorado_summary)[2, 1]
colorado_se <- coef(colorado_summary)[2, 2]

combined_slope <- coef(combined_summary)[2, 1]
combined_se <- coef(combined_summary)[2, 2]

# Output results
cat("Statistical Comparison of R0-Outbreak Size Relationships\n\n")
cat("Hildale, UT:\n")
cat(sprintf("  Slope: %.4f (SE: %.4f)\n", hildale_slope, hildale_se))
cat(sprintf("  R²: %.4f\n", hildale_summary$r.squared))
cat("\n")
cat("Colorado City, AZ:\n")
cat(sprintf("  Slope: %.4f (SE: %.4f)\n", colorado_slope, colorado_se))
cat(sprintf("  R²: %.4f\n", colorado_summary$r.squared))
cat("\n")
cat("Combined Cities:\n")
cat(sprintf("  Slope: %.4f (SE: %.4f)\n", combined_slope, combined_se))
cat(sprintf("  R²: %.4f\n", combined_summary$r.squared))
cat("\n")

cat("Summary:\n")
cat("The combined population shows the most gradual increase in outbreak size with R0,\n")
cat("suggesting that aggregating the populations provides a more stable epidemic profile.\n")
```

## Scenario 2: Linear Interpolation of Adult Vaccination Rates
Let's model outbreaks under this interpolated adult vaccination coverage.

We will interpolate vaccination rate for adults between the end of highschool age up to 95% for the 49-65 age groups.

```{r interpolation-adult-coverage}
# Define age limits and corresponding coverage rates
# current_coverage_95 is defined above
# for 20, 25, 30, 35, 40, 45, 50 adjust the rate to interpolate between 45% and 95%
adult_ages <- c(15, 20, 25, 30, 35, 40, 45, 50)
adult_rates <- seq(0.45, 0.95, length.out = length(adult_ages))

linear_coverage <- current_coverage_95

for (i in seq_along(adult_ages)) {
  age <- adult_ages[i]
  rate <- adult_rates[i]
  age_idx <- which(agelims[-length(agelims)] == age)
  linear_coverage[age_idx] <- rate
}

cat("Interpolated Adult Vaccination Coverage Rates:\n")
for (i in seq_along(adult_ages)) {
  age <- adult_ages[i]
  age_idx <- which(agelims[-length(agelims)] == age)
  cat(sprintf("  Age %d: %.2f%%\n", age, linear_coverage[age_idx] * 100))
}
```

### Combined communities visualization

```{r combined-linear-plot}
# Extract R0=15 results for comparison
# combine the two communities populations into one and run the sim on this combined data
combined_pops <- hildale_data$age_pops + colorado_data$age_pops

combined_95 <- multigroup.vaccine:::getOutputTable(
  agelims = agelims,
  agepops = combined_pops,
  agecovr = current_coverage_95,
  ageveff = ageveff,
  initgrp = initgrp
)

# print results for current coverage
cat("Combined Cities - Current Vaccination Coverage (95% adult rate)\n")
print(as.data.frame(combined_95), row.names = FALSE)

combined_linear <- multigroup.vaccine:::getOutputTable(
  agelims = agelims,
  agepops = combined_pops,
  agecovr = linear_coverage,
  ageveff = ageveff,
  initgrp = initgrp
)

cat("Combined Cities - Linear Interpolated Adult Vaccination Coverage\n")
print(as.data.frame(combined_linear), row.names = FALSE)

r0_15_idx <- which(combined_linear[, "R0"] == 15)
r0_15_idx_95 <- which(combined_95[, "R0"] == 15)

# Combine both scenarios into a single bar chart
combined_percentages <- c(
  100 * combined_95[r0_15_idx_95, "escapeInfTot"] / sum(combined_pops),
  100 * combined_linear[r0_15_idx, "escapeInfTot"] / sum(combined_pops)
)

scenario_names <- c("Current Coverage\n(95% adult rate)", "Linear Interpolated\nAdult Coverage")

# Create data frame for ggplot
scenario_data <- data.frame(
  Scenario = factor(scenario_names, levels = scenario_names),
  Percentage = combined_percentages,
  Color = c("#f7b360", "#9dd7da")
)

ggplot(scenario_data, aes(x = Scenario, y = Percentage, fill = Color)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), vjust = -0.5, size = 4) +
  scale_fill_identity() +
  labs(title = "Combined Communities: % of Population Infected (R0=15)",
       x = "Vaccination Scenario",
       y = "% of Population Infected") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  ylim(0, max(combined_percentages) * 1.1)
```


