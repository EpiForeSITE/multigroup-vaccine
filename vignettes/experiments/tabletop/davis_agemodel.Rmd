---
title: "Davis County Age-Structured Model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Davis County Age-Structured Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(multigroup.vaccine)
library(socialmixr)
```

This vignette demonstrates an age-structured model of transmission within a Davis County, Utah. 

First we define the age groups that we want use in our model. We define the `age_limits` vector using the lower limit (minimum age) of each group, starting with 0:

```{r}
# under 1, 1-4, 5-11, 12-13, 14-17, 18-24, 25-44, 45-69, 70 plus
age_limits <- c(0, 1, 5, 12, 14, 18, 25, 45, 70)
```

Next we collect census data from Davis County, Utah, using our custom age group choice:

```{r}
davis_data <- getCensusData(
  state_fips = getStateFIPS("Utah"),
  county_name = "Davis County",
  year = 2024,
  age_groups = age_limits,
  csv_path = getCensusDataPath()
)
```

Now we specify immunity levels of our population age groups due to vaccination and prior infection. Let's assume no prior immunity to H5N1.

```{r}
#age_immunity <- c(0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1)
age_immunity <- rep(0, length(age_limits))
```

Now we can begin defining the input arguments to our `finalsize` function so that we can estimate the outbreak size in this county after an introduction.

Initial population size of each disease state:

```{r}
popsize <- davis_data$age_pops

initV <- round(age_immunity * popsize)  # initially immune cases 

initI <- rep(0, length(popsize))  # initial infectious cases
initI[4] <- 1                     # assume 1 initial case in the 4th age group (12-13)

initR <- rep(0, length(popsize))  # no recent prior H5 flu survivors
```

Transmission matrix ingredients: contact matrix, relative susceptibility and transmissibility. The contact matrix uses Polymod contact survey data, adjusted for local population distribution:

```{r}
contactmatrix <- contactMatrixPolymod(age_limits, popsize)
relsusc <- rep(1, length(popsize))      # Assume no age differences in susceptibility
reltransm <- rep(1, length(popsize))    # or transmissibility per contact
```

## Basic reproduction number.

H5 flu could have a low level of transmissibility with $R0<1$ - let's see how outbreak sizes might look:

```{r}
outbreak_dist <- function(R0){
  fs <- finalsize(popsize, R0, contactmatrix, relsusc, reltransm, initR, initI, initV,
            method ="stochastic", nsims = 1000)
  table(rowSums(fs))
}

outbreak_dist(R0 = 0.1)
outbreak_dist(R0 = 0.2)
outbreak_dist(R0 = 0.3)
outbreak_dist(R0 = 0.4)
outbreak_dist(R0 = 0.5)
outbreak_dist(R0 = 0.6)
outbreak_dist(R0 = 0.7)
outbreak_dist(R0 = 0.8)
outbreak_dist(R0 = 0.9)
```
If $R_0 > 1$, there could be a very large outbreak. We can provide a quick estimate of outbreak sizes using our hybrid model:

```{r}
outbreak_dist_hybrid <- function(R0){
  fs <- finalsize(popsize, R0, contactmatrix, relsusc, reltransm, initR, initI, initV,
            method ="hybrid", nsims = 1000)
  table(rowSums(fs))
}

outbreak_dist_hybrid(R0 = 1.1)
outbreak_dist_hybrid(R0 = 1.2)
outbreak_dist_hybrid(R0 = 1.3)
outbreak_dist_hybrid(R0 = 1.4)
outbreak_dist_hybrid(R0 = 1.5)
outbreak_dist_hybrid(R0 = 1.6)
outbreak_dist_hybrid(R0 = 1.7)
outbreak_dist_hybrid(R0 = 1.8)
outbreak_dist_hybrid(R0 = 1.9)
```
